<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard User - TENNESA</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="user-style.css"> </head>
<body>
<header>
  <a href="index.html" class="logo">ðŸŽ¾ TENNESA</a>
  <nav>
    <a href="index.html" id="beranda-link">Beranda</a>
    <a href="tentang.html">Tentang</a>
    <a href="user.html" id="dashboard-link">Dashboard</a>
  </nav>
  <div class="auth-btn">
      </div>
</header>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h2 id="welcome-message">Dashboard User</h2>
    <p>Selamat datang kembali!</p>
  </div>

  <div class="tabs-container">
    <a class="tab active" data-tab="reservasi">Reservasi</a>
    <a class="tab" data-tab="profil">Profil</a>
    <a class="tab" data-tab="riwayat">Riwayat</a>
    <a class="tab" data-tab="notifikasi">Notifikasi</a>
  </div>

  <div class="tab-content active" id="reservasi">
    <div class="dashboard-grid">
      <div class="card">
        <div class="card-header"><h3>Buat Reservasi Baru</h3><p>Pilih tanggal, jam, dan lapangan</p></div>
        <div class="card-content">
          <form id="booking-form">
            <div class="form-group"><label for="tanggal">Tanggal</label><input type="date" id="tanggal" required></div>
            <div class="form-group"><label for="lapangan">Lapangan</label><select id="lapangan" required><option value="">Pilih lapangan</option></select></div>
            <div class="form-group"><label for="jam">Jam Mulai</label><select id="jam" required><option value="">Pilih jam</option><option>08:00</option><option>09:00</option><option>10:00</option><option>11:00</option><option>14:00</option><option>15:00</option><option>16:00</option><option>19:00</option><option>20:00</option></select></div>
            <div class="form-group"><label for="durasi">Durasi (jam)</label><select id="durasi" required><option value="1">1 jam</option><option value="2">2 jam</option></select></div>
            <button type="submit" class="btn-submit">Buat Reservasi</button>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Ketersediaan Lapangan</h3><p>Status lapangan hari ini</p></div>
        <div class="card-content">
          <div class="availability-list" id="availability-list">
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="profil">
    <div class="card">
      <div class="card-header"><h3>Profil Saya</h3><p>Kelola informasi pribadi Anda</p></div>
      <div class="card-content">
        <form id="profile-form">
          <div class="profile-grid">
            <div class="form-group"><label>Nama Lengkap</label><input type="text" id="profile-name" class="profile-field"></div>
            <div class="form-group"><label>Email</label><input type="email" id="profile-email" class="profile-field" disabled></div>
            <div class="form-group"><label>No. HP</label><input type="tel" id="profile-phone" class="profile-field"></div>
            <div class="form-group"><label>Role</label><input type="text" id="profile-role" class="profile-field" disabled></div>
          </div>
          <button type="submit" class="btn-dark">Simpan Perubahan</button>
        </form>
      </div>
    </div>
  </div>

  <div class="tab-content" id="riwayat">
    <div class="card">
      <div class="card-header"><h3>Riwayat Booking</h3><p>Daftar reservasi yang pernah Anda buat</p></div>
      <div class="card-content">
        <div class="history-list" id="history-list">
           <p>Tidak ada riwayat booking.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="notifikasi">
    <div class="card">
      <div class="card-header"><h3>Notifikasi</h3><p>Semua notifikasi untuk Anda</p></div>
      <div class="card-content">
        <div class="notification-list" id="notification-list">
          <p>Tidak ada notifikasi baru.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="script.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    // === Bagian Tab ===
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
        tab.addEventListener("click", (e) => {
            e.preventDefault();
            tabs.forEach(t => t.classList.remove("active"));
            contents.forEach(c => c.classList.remove("active"));
            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
        });
    });

    // === Variabel Global & Pengambilan Data ===
    // Ambil user dari localStorage (sudah diset saat login)
    const currentUser = JSON.parse(localStorage.getItem('user'));

    // Variabel ini akan diisi oleh API
    let courts = []; 
    // bookings dan notifications akan diambil langsung oleh fungsi load-nya

    // Jika tidak ada user, script.js seharusnya sudah me-redirect
    if (!currentUser) {
        console.error("Tidak ada user, redirect...");
        window.location.href = 'login.html'; // Fallback redirect
        return;
    }

    // === Bagian Profil ===
    const profileForm = document.getElementById('profile-form');
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    const profilePhone = document.getElementById('profile-phone');
    const profileRole = document.getElementById('profile-role');
    const welcomeMessage = document.getElementById('welcome-message');

    // Muat data profil (dari localStorage)
    const loadProfile = () => {
        profileName.value = currentUser.name || '';
        profileEmail.value = currentUser.email || '';
        profilePhone.value = currentUser.phone || '';
        profileRole.value = currentUser.role || '';
        welcomeMessage.textContent = `Dashboard ${currentUser.name || currentUser.email}`;
    };

    // Simpan perubahan profil (ke API)
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const updatedUser = {
            name: profileName.value,
            phone: profilePhone.value
        };

        try {
            const response = await fetch('api/profile.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedUser)
            });
            const data = await response.json();

            if (data.success) {
                // Update localStorage dengan data baru dari server
                localStorage.setItem('user', JSON.stringify(data.user));
                // Update header span (jika ada)
                const headerName = document.querySelector('.auth-btn span');
                if(headerName) {
                    headerName.textContent = `Halo, ${data.user.name}`;
                }
                alert('Profil berhasil diperbarui!');
                loadProfile(); // Muat ulang data di form
            } else {
                alert('Gagal memperbarui profil: ' + data.message);
            }
        } catch (error) {
            alert('Terjadi kesalahan saat memperbarui profil.');
        }
    });

    // === Bagian Reservasi & Ketersediaan ===
    const bookingForm = document.getElementById('booking-form');
    const lapanganSelect = document.getElementById('lapangan');
    const availabilityList = document.getElementById('availability-list');
    const tanggalInput = document.getElementById('tanggal');
    
    // Set tanggal minimal hari ini
    const today = new Date().toISOString().split('T')[0];
    tanggalInput.setAttribute('min', today);


    // Muat daftar lapangan di form dan list ketersediaan (dari API)
    const loadCourts = async () => {
        try {
            const response = await fetch('api/courts.php');
            courts = await response.json(); // Simpan di variabel global

            // Form
            lapanganSelect.innerHTML = '<option value="">Pilih lapangan</option>';
            courts.filter(c => c.status === 'Tersedia').forEach(court => {
                const option = document.createElement('option');
                option.value = court.id;
                option.textContent = `${court.name} - Rp ${parseInt(court.price).toLocaleString('id-ID')}/jam`;
                lapanganSelect.appendChild(option);
            });

            // List Ketersediaan
            availabilityList.innerHTML = '';
            courts.forEach(court => {
                const item = document.createElement('div');
                item.className = 'court-item';
                item.innerHTML = `
                    <div class="court-info">
                        <p><strong>${court.name}</strong></p>
                        <p class="price">Rp ${parseInt(court.price).toLocaleString('id-ID')}/jam</p>
                    </div>
                    <span class="status-badge ${court.status === 'Tersedia' ? 'tersedia' : 'penuh'}">${court.status}</span>
                `;
                availabilityList.appendChild(item);
            });
        } catch (error) {
            console.error("Gagal memuat data lapangan:", error);
            availabilityList.innerHTML = '<p>Gagal memuat data lapangan.</p>';
        }
    };

    // Handle submit form reservasi (ke API)
    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const courtId = parseInt(lapanganSelect.value);
        const selectedCourt = courts.find(c => c.id === courtId);
        
        if (!selectedCourt) {
            alert('Silakan pilih lapangan yang valid!');
            return;
        }

        const newBooking = {
            // userId akan diambil dari sesi di server
            courtId: selectedCourt.id,
            courtName: selectedCourt.name, // Kirim nama untuk notifikasi
            date: tanggalInput.value,
            time: document.getElementById('jam').value,
            duration: parseInt(document.getElementById('durasi').value),
            totalPrice: selectedCourt.price * parseInt(document.getElementById('durasi').value)
        };
        
        try {
            const response = await fetch('api/bookings.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newBooking)
            });
            const data = await response.json();

            if (data.success) {
                alert('Reservasi berhasil dibuat!');
                bookingForm.reset();
                loadHistory(); // Muat ulang riwayat
                loadNotifications(); // Muat ulang notifikasi (dibuat di server)
            } else {
                alert('Gagal membuat reservasi: ' + data.message);
            }
        } catch (error) {
             alert('Terjadi kesalahan saat membuat reservasi.');
        }
    });

    // === Bagian Riwayat ===
    const historyList = document.getElementById('history-list');
    const loadHistory = async () => {
        try {
            const response = await fetch('api/bookings.php'); // API akan filter by user session
            const userBookings = await response.json();
            
            historyList.innerHTML = '';
            if (userBookings.length === 0) {
                historyList.innerHTML = '<p>Tidak ada riwayat booking.</p>';
                return;
            }
            // Data sudah diurutkan dari server
            userBookings.forEach(booking => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-details">
                        <p><strong>${booking.courtName}</strong></p>
                        <p class="detail-meta">${booking.booking_date} ãƒ» ${booking.start_time} ãƒ» ${booking.duration} jam</p>
                        <p class="detail-price">Total Rp. ${booking.total_price.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="history-status">
                        <span class="status-badge ${booking.status === 'Aktif' ? 'aktif' : 'selesai'}">${booking.status}</span>
                        <p class="payment-status">${booking.payment_status}</p>
                    </div>
                `;
                historyList.appendChild(item);
            });
        } catch (error) {
            console.error("Gagal memuat riwayat:", error);
            historyList.innerHTML = '<p>Gagal memuat riwayat booking.</p>';
        }
    };
    
    // === Bagian Notifikasi ===
    const notificationList = document.getElementById('notification-list');
    const loadNotifications = async () => {
        try {
            const response = await fetch('api/notifications.php');
            const userNotifications = await response.json();
            
            notificationList.innerHTML = '';
            if (userNotifications.length === 0) {
                notificationList.innerHTML = '<p>Tidak ada notifikasi baru.</p>';
                return;
            }
            // Data sudah diurutkan dari server
            userNotifications.forEach(notif => {
                const item = document.createElement('div');
                item.className = 'notification-item';
                item.innerHTML = `
                    <h4>${notif.title}</h4>
                    <p>${notif.message}</p>
                    <p class="timestamp">${notif.timestamp}</p>
                `;
                notificationList.appendChild(item);
            });
        } catch (error) {
            console.error("Gagal memuat notifikasi:", error);
            notificationList.innerHTML = '<p>Gagal memuat notifikasi.</p>';
        }
    };


    // === Panggil Semua Fungsi Load Awal ===
    loadProfile();
    loadCourts();
    loadHistory();
    loadNotifications();
});
</script>
</body>
</html>